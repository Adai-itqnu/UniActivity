<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{admin/layout :: header}"></head>
  <body>
    <div th:replace="~{admin/layout :: sidebar}"></div>

    <div class="content">
      <div class="container-fluid">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <a th:href="@{/admin/activities}" class="btn btn-outline-secondary btn-sm mb-2">
              <i class="fas fa-arrow-left me-1"></i> Quay l·∫°i
            </a>
            <h2 class="mb-0"><i class="fas fa-plus-circle text-primary me-2"></i>T·∫°o Ho·∫°t ƒë·ªông m·ªõi</h2>
          </div>
        </div>

        <!-- Wizard Progress -->
        <div class="card mb-4">
          <div class="card-body py-3">
            <div class="d-flex justify-content-between align-items-center position-relative">
              <div class="position-absolute w-100" style="top: 50%; height: 2px; background: #dee2e6; z-index: 0;"></div>
              
              <div class="wizard-step text-center position-relative" style="z-index: 1;">
                <div class="step-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" 
                     style="width: 40px; height: 40px;" id="stepIcon1">
                  <span>1</span>
                </div>
                <small class="d-block fw-bold text-primary" id="stepLabel1">Th√¥ng tin</small>
              </div>
              
              <div class="wizard-step text-center position-relative" style="z-index: 1;">
                <div class="step-icon bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" 
                     style="width: 40px; height: 40px;" id="stepIcon2">
                  <span>2</span>
                </div>
                <small class="d-block text-muted" id="stepLabel2">Slots</small>
              </div>
              
              <div class="wizard-step text-center position-relative" style="z-index: 1;">
                <div class="step-icon bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" 
                     style="width: 40px; height: 40px;" id="stepIcon3">
                  <span>3</span>
                </div>
                <small class="d-block text-muted" id="stepLabel3">ƒêi·ªÉm/Gi·∫£i</small>
              </div>
              
              <div class="wizard-step text-center position-relative" style="z-index: 1;">
                <div class="step-icon bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" 
                     style="width: 40px; height: 40px;" id="stepIcon4">
                  <span>4</span>
                </div>
                <small class="d-block text-muted" id="stepLabel4">Xem l·∫°i</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 1: Basic Info -->
        <div class="card step-content" id="step1">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>B∆∞·ªõc 1: Th√¥ng tin c∆° b·∫£n</h5>
          </div>
          <div class="card-body">
            <form id="basicInfoForm">
              <div class="row">
                <div class="col-md-8">
                  <div class="mb-3">
                    <label class="form-label">T√™n ho·∫°t ƒë·ªông <span class="text-danger">*</span></label>
                    <input type="text" id="actName" class="form-control form-control-lg" placeholder="VD: H·ªôi thao sinh vi√™n 2024" required>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Ph·∫°m vi <span class="text-danger">*</span></label>
                    <select id="actScope" class="form-select form-select-lg" required>
                      <option value="SCHOOL">üè´ To√†n tr∆∞·ªùng</option>
                      <option value="FACULTY">üèõÔ∏è Theo khoa</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label">M√¥ t·∫£</label>
                <textarea id="actDescription" class="form-control" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ ho·∫°t ƒë·ªông..."></textarea>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">ƒê·ªãa ƒëi·ªÉm</label>
                    <input type="text" id="actLocation" class="form-control" placeholder="VD: H·ªôi tr∆∞·ªùng A">
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Banner (Ch·ªçn file t·ª´ m√°y)</label>
                    <input type="file" id="bannerFile" class="form-control" accept="image/*">
                    <small class="text-muted">H·ªó tr·ª£: JPG, PNG, GIF. T·ªëi ƒëa 5MB</small>
                    <div id="bannerPreview" class="mt-2" style="display: none;">
                      <img id="bannerPreviewImg" src="" alt="Preview" class="img-fluid rounded" style="max-height: 200px;">
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Ho·∫∑c nh·∫≠p URL banner</label>
                    <input type="url" id="actBanner" class="form-control" placeholder="https://example.com/banner.jpg">
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Th·ªùi gian b·∫Øt ƒë·∫ßu <span class="text-danger">*</span></label>
                    <input type="datetime-local" id="actStartTime" class="form-control" required>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Th·ªùi gian k·∫øt th√∫c</label>
                    <input type="datetime-local" id="actEndTime" class="form-control">
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">H·∫°n ƒëƒÉng k√Ω</label>
                    <input type="datetime-local" id="actDeadline" class="form-control">
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label">Tr·∫°ng th√°i</label>
                <select id="actStatus" class="form-select">
                  <option value="DRAFT">üìù Nh√°p (ch∆∞a c√¥ng khai)</option>
                  <option value="OPEN">‚úÖ M·ªü ƒëƒÉng k√Ω</option>
                </select>
              </div>
            </form>
          </div>
          <div class="card-footer d-flex justify-content-end">
            <button class="btn btn-primary btn-lg" onclick="goToStep(2)">
              Ti·∫øp theo <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>
        </div>

        <!-- Step 2: Slots -->
        <div class="card step-content d-none" id="step2">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>B∆∞·ªõc 2: Ph√¢n b·ªï Slots</h5>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <i class="fas fa-lightbulb me-2"></i>
              <strong>H∆∞·ªõng d·∫´n:</strong>
              <span id="slotGuide"></span>
            </div>
            
            <!-- School Mode -->
            <div id="slotSchoolMode" class="mb-4">
              <div class="row align-items-end">
                <div class="col-md-4">
                  <label class="form-label">S·ªë l∆∞·ª£ng t·ªëi ƒëa to√†n tr∆∞·ªùng <span class="text-danger">*</span></label>
                  <input type="number" id="slotSchoolQuantity" class="form-control" min="1" placeholder="VD: 100">
                </div>
                <div class="col-md-4">
                  <button type="button" class="btn btn-success" onclick="addSchoolSlot()">
                    <i class="fas fa-plus me-1"></i>Th√™m
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Faculty Mode -->
            <div id="slotFacultyMode" class="mb-4 d-none">
              <div class="row align-items-end">
                <div class="col-md-3">
                  <label class="form-label">Khoa <span class="text-danger">*</span></label>
                  <select id="slotFacultyId" class="form-select" onchange="filterSlotClasses()">
                    <option value="">-- Ch·ªçn khoa --</option>
                    <option th:each="f : ${faculties}" th:value="${f.id}" th:text="${f.name}">Khoa</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">L·ªõp (t√πy ch·ªçn)</label>
                  <select id="slotClassId" class="form-select">
                    <option value="">-- T·∫•t c·∫£ l·ªõp --</option>
                    <option th:each="c : ${classes}" th:value="${c.id}" th:text="${c.name}" th:data-faculty="${c.facultyId}">L·ªõp</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">S·ªë l∆∞·ª£ng <span class="text-danger">*</span></label>
                  <input type="number" id="slotMaxQuantity" class="form-control" min="1" placeholder="VD: 50">
                </div>
                <div class="col-md-3">
                  <button type="button" class="btn btn-success" onclick="addFacultySlot()">
                    <i class="fas fa-plus me-1"></i>Th√™m slot
                  </button>
                </div>
              </div>
              <small class="text-muted mt-2 d-block">ƒê·ªÉ tr·ªëng l·ªõp = √°p d·ª•ng cho c·∫£ khoa.</small>
            </div>
            
            <hr>
            <h6><i class="fas fa-list me-2"></i>Danh s√°ch Slots ƒë√£ th√™m:</h6>
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Khoa</th>
                  <th>L·ªõp</th>
                  <th class="text-center">S·ªë l∆∞·ª£ng</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="slotsList">
                <tr id="noSlotsRow">
                  <td colspan="4" class="text-center text-muted py-3">Ch∆∞a th√™m slot n√†o</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="card-footer d-flex justify-content-between">
            <button class="btn btn-outline-secondary btn-lg" onclick="goToStep(1)">
              <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
            <button class="btn btn-primary btn-lg" onclick="goToStep(3)">
              Ti·∫øp theo <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Score Options -->
        <div class="card step-content d-none" id="step3">
          <div class="card-header bg-warning">
            <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>B∆∞·ªõc 3: ƒêi·ªÉm &amp; Gi·∫£i th∆∞·ªüng</h5>
          </div>
          <div class="card-body">
            <div class="alert alert-warning">
              <i class="fas fa-lightbulb me-2"></i>
              <strong>H∆∞·ªõng d·∫´n:</strong> Th√™m c√°c m·ª©c ƒëi·ªÉm/gi·∫£i th∆∞·ªüng cho t·ª´ng lo·∫°i tham gia.
            </div>
            
            <div class="row align-items-end mb-4">
              <div class="col-md-3">
                <label class="form-label">M·ª•c ƒëi·ªÉm <span class="text-danger">*</span></label>
                <select id="scoreCategory" class="form-select" required>
                  <option value="">-- Ch·ªçn m·ª•c --</option>
                  <!-- Populated by JS from scoring rules -->
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Lo·∫°i tham gia <span class="text-danger">*</span></label>
                <input type="text" id="scoreName" class="form-control" placeholder="VD: Gi·∫£i nh·∫•t">
              </div>
              <div class="col-md-2">
                <label class="form-label">ƒêi·ªÉm <span class="text-danger">*</span></label>
                <input type="number" id="scoreValue" class="form-control" min="0" placeholder="10">
              </div>
              <div class="col-md-2">
                <label class="form-label">Ghi ch√∫</label>
                <input type="text" id="scoreDescription" class="form-control" placeholder="Ghi ch√∫">
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-warning w-100" onclick="addScoreOption()">
                  <i class="fas fa-plus me-1"></i>Th√™m
                </button>
              </div>
            </div>
            
            <hr>
            <h6><i class="fas fa-list me-2"></i>Danh s√°ch ƒêi·ªÉm/Gi·∫£i th∆∞·ªüng:</h6>
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>M·ª•c ƒëi·ªÉm</th>
                  <th>Lo·∫°i tham gia</th>
                  <th class="text-center">ƒêi·ªÉm</th>
                  <th>Ghi ch√∫</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="scoresList">
                <tr id="noScoresRow">
                  <td colspan="5" class="text-center text-muted py-3">Ch∆∞a th√™m m·ª©c ƒëi·ªÉm n√†o</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="card-footer d-flex justify-content-between">
            <button class="btn btn-outline-secondary btn-lg" onclick="goToStep(2)">
              <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
            <button class="btn btn-primary btn-lg" onclick="goToStep(4)">
              Ti·∫øp theo <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>
        </div>

        <!-- Step 4: Review & Save -->
        <div class="card step-content d-none" id="step4">
          <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>B∆∞·ªõc 4: Xem l·∫°i &amp; L∆∞u</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header"><i class="fas fa-info-circle me-2"></i>Th√¥ng tin c∆° b·∫£n</div>
                  <div class="card-body" id="reviewBasicInfo"></div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header"><i class="fas fa-users me-2"></i>Slots (<span id="reviewSlotCount">0</span>)</div>
                  <div class="card-body p-0" id="reviewSlots"></div>
                </div>
                <div class="card">
                  <div class="card-header"><i class="fas fa-trophy me-2"></i>ƒêi·ªÉm (<span id="reviewScoreCount">0</span>)</div>
                  <div class="card-body p-0" id="reviewScores"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-between">
            <button class="btn btn-outline-secondary btn-lg" onclick="goToStep(3)">
              <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
            <button class="btn btn-success btn-lg" onclick="saveActivity()" id="saveBtn">
              <i class="fas fa-save me-2"></i>L∆∞u Ho·∫°t ƒë·ªông
            </button>
          </div>
        </div>
      </div>
    </div>

    <div th:replace="~{admin/layout :: scripts}"></div>
    
    <script th:inline="javascript">
      // Load scoring rules from server
      const scoringRulesJson = /*[[${scoringRulesJson}]]*/ '{}';
      const scoringRules = JSON.parse(scoringRulesJson);
      
      let currentStep = 1;
      let wizardData = { activity: {}, slots: [], scores: [] };
      let bannerFileToUpload = null;
      
      // Populate score category dropdown on load
      document.addEventListener('DOMContentLoaded', function() {
        populateCategorySelect();
        
        // Banner file preview handler
        const bannerFile = document.getElementById('bannerFile');
        if (bannerFile) {
          bannerFile.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
              bannerFileToUpload = file;
              const reader = new FileReader();
              reader.onload = function(e) {
                document.getElementById('bannerPreviewImg').src = e.target.result;
                document.getElementById('bannerPreview').style.display = 'block';
              };
              reader.readAsDataURL(file);
              // Clear URL input if file is selected
              document.getElementById('actBanner').value = '';
            } else {
              bannerFileToUpload = null;
              document.getElementById('bannerPreview').style.display = 'none';
            }
          });
        }
      });
      
      function populateCategorySelect() {
        const select = document.getElementById('scoreCategory');
        if (!scoringRules.categories) return;
        
        scoringRules.categories.forEach(cat => {
          // Only show AUTO_ACTIVITY categories (for activities that give points)
          const autoSubs = cat.subcategories.filter(sub => sub.type === 'AUTO_ACTIVITY');
          if (autoSubs.length === 0) return;
          
          const optgroup = document.createElement('optgroup');
          optgroup.label = `${cat.id}. ${cat.name}`;
          autoSubs.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.id;
            option.textContent = `${sub.id}. ${sub.name}`;
            optgroup.appendChild(option);
          });
          select.appendChild(optgroup);
        });
      }
      
      function goToStep(step) {
        if (step > currentStep && currentStep === 1 && !validateStep1()) return;
        
        for (let i = 1; i <= 4; i++) {
          document.getElementById('step' + i).classList.toggle('d-none', i !== step);
          const icon = document.getElementById('stepIcon' + i);
          const label = document.getElementById('stepLabel' + i);
          
          if (i < step) {
            icon.className = 'step-icon bg-success text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2';
            icon.innerHTML = '<i class="fas fa-check"></i>';
            label.className = 'd-block fw-bold text-success';
          } else if (i === step) {
            icon.className = 'step-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2';
            icon.innerHTML = '<span>' + i + '</span>';
            label.className = 'd-block fw-bold text-primary';
          } else {
            icon.className = 'step-icon bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2';
            icon.innerHTML = '<span>' + i + '</span>';
            label.className = 'd-block text-muted';
          }
        }
        currentStep = step;
        if (step === 2) updateSlotMode();
        else if (step === 4) buildReview();
      }
      
      function validateStep1() {
        const form = document.getElementById('basicInfoForm');
        if (!form.checkValidity()) { form.reportValidity(); return false; }
        wizardData.activity = {
          name: document.getElementById('actName').value,
          scope: document.getElementById('actScope').value,
          description: document.getElementById('actDescription').value,
          location: document.getElementById('actLocation').value,
          bannerUrl: document.getElementById('actBanner').value,
          startTime: document.getElementById('actStartTime').value || null,
          endTime: document.getElementById('actEndTime').value || null,
          registrationDeadline: document.getElementById('actDeadline').value || null,
          status: document.getElementById('actStatus').value
        };
        return true;
      }
      
      function updateSlotMode() {
        const scope = wizardData.activity.scope;
        document.getElementById('slotSchoolMode').classList.toggle('d-none', scope !== 'SCHOOL');
        document.getElementById('slotFacultyMode').classList.toggle('d-none', scope === 'SCHOOL');
        document.getElementById('slotGuide').textContent = scope === 'SCHOOL' 
          ? 'Ho·∫°t ƒë·ªông to√†n tr∆∞·ªùng: Ch·ªâ c·∫ßn nh·∫≠p s·ªë l∆∞·ª£ng t·ªëi ƒëa.'
          : 'Ho·∫°t ƒë·ªông theo khoa: Ch·ªçn khoa v√† s·ªë l∆∞·ª£ng slot.';
      }
      
      function filterSlotClasses() {
        const facultyId = document.getElementById('slotFacultyId').value;
        const classSelect = document.getElementById('slotClassId');
        Array.from(classSelect.options).forEach(opt => {
          if (!opt.value) return;
          opt.hidden = facultyId && opt.dataset.faculty !== facultyId;
        });
        classSelect.value = '';
      }
      
      function addSchoolSlot() {
        const qty = document.getElementById('slotSchoolQuantity').value;
        if (!qty || qty <= 0) { Toast.error('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá'); return; }
        wizardData.slots = [{ facultyId: null, facultyName: 'To√†n tr∆∞·ªùng', classId: null, className: 'T·∫•t c·∫£', maxQuantity: qty }];
        renderSlotsList();
        document.getElementById('slotSchoolQuantity').value = '';
      }
      
      function addFacultySlot() {
        const facultyId = document.getElementById('slotFacultyId').value;
        const facultyName = document.getElementById('slotFacultyId').selectedOptions[0]?.text || '';
        const classId = document.getElementById('slotClassId').value;
        const className = document.getElementById('slotClassId').selectedOptions[0]?.text || 'T·∫•t c·∫£';
        const qty = document.getElementById('slotMaxQuantity').value;
        
        if (!facultyId) { Toast.error('Vui l√≤ng ch·ªçn khoa'); return; }
        if (!qty || qty <= 0) { Toast.error('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá'); return; }
        
        wizardData.slots.push({ facultyId, facultyName, classId: classId || null, className, maxQuantity: qty });
        renderSlotsList();
        document.getElementById('slotFacultyId').value = '';
        document.getElementById('slotClassId').value = '';
        document.getElementById('slotMaxQuantity').value = '';
      }
      
      function removeSlot(index) { wizardData.slots.splice(index, 1); renderSlotsList(); }
      
      function renderSlotsList() {
        const tbody = document.getElementById('slotsList');
        if (wizardData.slots.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Ch∆∞a th√™m slot n√†o</td></tr>';
          return;
        }
        tbody.innerHTML = wizardData.slots.map((s, i) => 
          '<tr><td>' + s.facultyName + '</td><td>' + s.className + '</td><td class="text-center"><span class="badge bg-primary">' + s.maxQuantity + '</span></td><td class="text-center"><button class="btn btn-sm btn-danger" onclick="removeSlot(' + i + ')"><i class="fas fa-trash"></i></button></td></tr>'
        ).join('');
      }
      
      function addScoreOption() {
        const category = document.getElementById('scoreCategory').value;
        const categoryText = document.getElementById('scoreCategory').selectedOptions[0]?.text || '';
        const name = document.getElementById('scoreName').value;
        const value = document.getElementById('scoreValue').value;
        const desc = document.getElementById('scoreDescription').value;
        
        if (!category) { Toast.error('Vui l√≤ng ch·ªçn m·ª•c ƒëi·ªÉm'); return; }
        if (!name) { Toast.error('Vui l√≤ng nh·∫≠p lo·∫°i tham gia'); return; }
        if (!value) { Toast.error('Vui l√≤ng nh·∫≠p ƒëi·ªÉm'); return; }
        
        wizardData.scores.push({ scoreCategory: category, categoryText, name, scoreValue: value, description: desc });
        renderScoresList();
        document.getElementById('scoreCategory').value = '';
        document.getElementById('scoreName').value = '';
        document.getElementById('scoreValue').value = '';
        document.getElementById('scoreDescription').value = '';
      }
      
      function removeScore(index) { wizardData.scores.splice(index, 1); renderScoresList(); }
      
      function renderScoresList() {
        const tbody = document.getElementById('scoresList');
        if (wizardData.scores.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Ch∆∞a th√™m m·ª©c ƒëi·ªÉm n√†o</td></tr>';
          return;
        }
        tbody.innerHTML = wizardData.scores.map((s, i) =>
          '<tr><td><span class="badge bg-info">' + s.categoryText + '</span></td><td>' + s.name + '</td><td class="text-center"><span class="badge bg-success">+' + s.scoreValue + 'ƒë</span></td><td>' + (s.description || '-') + '</td><td class="text-center"><button class="btn btn-sm btn-danger" onclick="removeScore(' + i + ')"><i class="fas fa-trash"></i></button></td></tr>'
        ).join('');
      }
      
      function buildReview() {
        const a = wizardData.activity;
        document.getElementById('reviewBasicInfo').innerHTML = 
          '<table class="table table-sm mb-0"><tr><th>T√™n:</th><td>' + a.name + '</td></tr><tr><th>Ph·∫°m vi:</th><td>' + (a.scope === 'SCHOOL' ? 'üè´ To√†n tr∆∞·ªùng' : 'üèõÔ∏è Theo khoa') + '</td></tr><tr><th>ƒê·ªãa ƒëi·ªÉm:</th><td>' + (a.location || '-') + '</td></tr><tr><th>Th·ªùi gian:</th><td>' + (a.startTime || '-') + '</td></tr><tr><th>Tr·∫°ng th√°i:</th><td>' + (a.status === 'DRAFT' ? 'üìù Nh√°p' : '‚úÖ M·ªü ƒëƒÉng k√Ω') + '</td></tr></table>';
        
        document.getElementById('reviewSlotCount').textContent = wizardData.slots.length;
        document.getElementById('reviewSlots').innerHTML = wizardData.slots.length === 0 
          ? '<p class="text-center text-muted py-3 mb-0">Kh√¥ng c√≥ slot</p>'
          : '<table class="table table-sm mb-0">' + wizardData.slots.map(s => '<tr><td>' + s.facultyName + '</td><td>' + s.className + '</td><td class="text-center">' + s.maxQuantity + '</td></tr>').join('') + '</table>';
        
        document.getElementById('reviewScoreCount').textContent = wizardData.scores.length;
        document.getElementById('reviewScores').innerHTML = wizardData.scores.length === 0
          ? '<p class="text-center text-muted py-3 mb-0">Kh√¥ng c√≥ ƒëi·ªÉm</p>'
          : '<table class="table table-sm mb-0">' + wizardData.scores.map(s => '<tr><td>' + s.name + '</td><td class="text-center">+' + s.scoreValue + 'ƒë</td></tr>').join('') + '</table>';
      }
      
      async function saveActivity() {
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang l∆∞u...';
        
        try {
          // Upload banner file first if selected
          if (bannerFileToUpload) {
            const formData = new FormData();
            formData.append('file', bannerFileToUpload);
            
            const uploadResponse = await fetch('/admin/activities/api/upload-banner', {
              method: 'POST',
              body: formData
            });
            
            if (uploadResponse.ok) {
              const uploadResult = await uploadResponse.json();
              wizardData.activity.bannerUrl = uploadResult.bannerUrl;
            } else {
              const err = await uploadResponse.json();
              throw new Error(err.error || 'L·ªói upload banner');
            }
          }
          
          const actResponse = await fetch('/admin/activities/api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(wizardData.activity)
          });
          
          if (!actResponse.ok) { const err = await actResponse.json(); throw new Error(err.message || 'L·ªói t·∫°o ho·∫°t ƒë·ªông'); }
          
          const activity = await actResponse.json();
          const activityId = activity.id;
          
          for (const slot of wizardData.slots) {
            await fetch('/admin/activities/api/' + activityId + '/slots', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(slot)
            });
          }
          
          for (const score of wizardData.scores) {
            await fetch('/admin/activities/api/' + activityId + '/score-options', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(score)
            });
          }
          
          Toast.success('T·∫°o ho·∫°t ƒë·ªông th√†nh c√¥ng!');
          setTimeout(() => { window.location.href = '/admin/activities/' + activityId; }, 1000);
        } catch (error) {
          Toast.error('L·ªói: ' + error.message);
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>L∆∞u Ho·∫°t ƒë·ªông';
        }
      }
    </script>
  </body>
</html>
