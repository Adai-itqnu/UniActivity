<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{admin/layout :: header}"></head>
  <body>
    <div th:replace="~{admin/layout :: sidebar}"></div>

    <div class="content">
      <div class="container-fluid">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <a th:href="@{/admin/activities}" class="btn btn-outline-secondary btn-sm mb-2">
              <i class="fas fa-arrow-left me-1"></i> Quay l·∫°i
            </a>
            <h2 class="mb-0" th:text="${activity.name}">T√™n ho·∫°t ƒë·ªông</h2>
          </div>
          <div>
            <span th:if="${activity.scope == 'SCHOOL'}" class="badge bg-primary fs-6 me-2">üè´ To√†n tr∆∞·ªùng</span>
            <span th:if="${activity.scope == 'FACULTY'}" class="badge bg-info fs-6 me-2">üèõÔ∏è Theo khoa</span>
            <span th:if="${activity.status == 'DRAFT'}" class="badge bg-secondary fs-6">üìù Nh√°p</span>
            <span th:if="${activity.status == 'OPEN'}" class="badge bg-success fs-6">‚úÖ M·ªü ƒëƒÉng k√Ω</span>
            <span th:if="${activity.status == 'FINISHED'}" class="badge bg-dark fs-6">‚èπÔ∏è K·∫øt th√∫c</span>
          </div>
        </div>
        <!-- Summary Stats Row -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card bg-primary text-white">
              <div class="card-body text-center py-3">
                <h4 class="mb-0" th:text="${totalMaxSlots ?: 0}">100</h4>
                <small>T·ªïng slot</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body text-center py-3">
                <h4 class="mb-0" th:text="${totalRegistered ?: 0}">45</h4>
                <small>ƒê√£ ƒëƒÉng k√Ω</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-warning">
              <div class="card-body text-center py-3">
                <h4 class="mb-0" th:text="${totalRemaining ?: 0}">55</h4>
                <small>C√≤n tr·ªëng</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card" th:classappend="${isDeadlinePassed} ? 'bg-danger text-white' : 'bg-info text-white'">
              <div class="card-body text-center py-3">
                <h6 class="mb-0" th:if="${activity.registrationDeadline != null}" 
                    th:text="${#temporals.format(activity.registrationDeadline, 'dd/MM HH:mm')}">31/12 23:59</h6>
                <h6 class="mb-0" th:unless="${activity.registrationDeadline != null}">--</h6>
                <small th:text="${isDeadlinePassed} ? '‚ö†Ô∏è ƒê√£ h·∫øt h·∫°n' : 'üìÖ H·∫°n ƒëƒÉng k√Ω'">H·∫°n ƒëƒÉng k√Ω</small>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Left Column: Basic Info -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <i class="fas fa-info-circle me-2"></i>Th√¥ng tin c∆° b·∫£n
              </div>
              <div class="card-body">
                <table class="table table-borderless mb-0">
                  <tr>
                    <th width="35%"><i class="fas fa-map-marker-alt me-2 text-muted"></i>ƒê·ªãa ƒëi·ªÉm:</th>
                    <td th:text="${activity.location ?: 'Ch∆∞a c√≥'}">H·ªôi tr∆∞·ªùng A</td>
                  </tr>
                  <tr>
                    <th><i class="fas fa-play me-2 text-success"></i>B·∫Øt ƒë·∫ßu:</th>
                    <td>
                      <strong th:text="${activity.startTime != null ? #temporals.format(activity.startTime, 'dd/MM/yyyy HH:mm') : 'Ch∆∞a c√≥'}">01/01/2024</strong>
                    </td>
                  </tr>
                  <tr>
                    <th><i class="fas fa-stop me-2 text-danger"></i>K·∫øt th√∫c:</th>
                    <td th:text="${activity.endTime != null ? #temporals.format(activity.endTime, 'dd/MM/yyyy HH:mm') : 'Ch∆∞a c√≥'}">01/01/2024</td>
                  </tr>
                  <tr>
                    <th><i class="fas fa-calendar-check me-2 text-warning"></i>H·∫°n ƒëƒÉng k√Ω:</th>
                    <td>
                      <span th:if="${activity.registrationDeadline != null}" th:classappend="${isDeadlinePassed} ? 'text-danger fw-bold' : 'text-success'"
                            th:text="${#temporals.format(activity.registrationDeadline, 'dd/MM/yyyy HH:mm')}">31/12/2023</span>
                      <span th:unless="${activity.registrationDeadline != null}" class="text-muted">Ch∆∞a c√≥</span>
                      <span th:if="${isDeadlinePassed}" class="badge bg-danger ms-2">ƒê√£ h·∫øt h·∫°n</span>
                    </td>
                  </tr>
                  <tr>
                    <th><i class="fas fa-clock me-2 text-info"></i>Ng√†y t·∫°o:</th>
                    <td th:text="${activity.createdAt != null ? #temporals.format(activity.createdAt, 'dd/MM/yyyy HH:mm') : '-'}">-</td>
                  </tr>
                </table>
                <hr>
                <h6><i class="fas fa-align-left me-2"></i>M√¥ t·∫£:</h6>
                <p class="text-muted" th:text="${activity.description ?: 'Ch∆∞a c√≥ m√¥ t·∫£'}">M√¥ t·∫£ ho·∫°t ƒë·ªông</p>
              </div>
            </div>
          </div>

          <!-- Right Column: Banner -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-secondary text-white">
                <i class="fas fa-image me-2"></i>Banner
              </div>
              <div class="card-body text-center">
                <img th:if="${activity.bannerUrl}" th:src="${activity.bannerUrl}" alt="Banner" class="img-fluid rounded" style="max-height: 250px;">
                <div th:unless="${activity.bannerUrl}" class="text-muted py-5">
                  <i class="fas fa-image fa-3x mb-3"></i>
                  <p>Ch∆∞a c√≥ banner</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Slots Section -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-users me-2"></i>Slots ƒëƒÉng k√Ω</span>
                <button class="btn btn-light btn-sm" onclick="openAddSlotModal()">
                  <i class="fas fa-plus"></i> Th√™m
                </button>
              </div>
              <div class="card-body p-0">
                <table class="table table-sm mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Khoa</th>
                      <th>L·ªõp</th>
                      <th class="text-center">S·ªë l∆∞·ª£ng</th>
                      <th class="text-center">C√≤n l·∫°i</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="slotsList">
                    <tr th:each="slot : ${slots}">
                      <td th:text="${slot.facultyName ?: 'To√†n tr∆∞·ªùng'}">Khoa CNTT</td>
                      <td th:text="${slot.className ?: 'T·∫•t c·∫£'}">K45-CNTT</td>
                      <td class="text-center" th:text="${slot.maxQuantity}">50</td>
                      <td class="text-center">
                        <span class="badge bg-success" th:text="${slot.maxQuantity - (slot.currentQuantity ?: 0)}">30</span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-danger" th:onclick="|deleteSlot(${slot.id})|">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(slots)}">
                      <td colspan="5" class="text-center text-muted py-3">Ch∆∞a c√≥ slot n√†o</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Score Options Section -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header bg-warning d-flex justify-content-between align-items-center">
                <span><i class="fas fa-trophy me-2"></i>ƒêi·ªÉm &amp; Gi·∫£i th∆∞·ªüng</span>
                <button class="btn btn-dark btn-sm" onclick="openAddScoreModal()">
                  <i class="fas fa-plus"></i> Th√™m
                </button>
              </div>
              <div class="card-body p-0">
                <table class="table table-sm mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>M·ª•c ƒëi·ªÉm</th>
                      <th>Lo·∫°i tham gia</th>
                      <th class="text-center">ƒêi·ªÉm</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="scoresList">
                    <tr th:each="opt : ${scoreOptions}">
                      <td>
                        <span class="badge bg-info" th:text="${opt.scoreCategory}">1.2</span>
                      </td>
                      <td th:text="${opt.name}">Gi·∫£i nh·∫•t</td>
                      <td class="text-center">
                        <span class="badge bg-primary" th:text="${'+' + opt.scoreValue + 'ƒë'}">+10ƒë</span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-danger" th:onclick="|deleteScoreOption(${opt.id})|">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(scoreOptions)}">
                      <td colspan="4" class="text-center text-muted py-3">Ch∆∞a c√≥ m·ª©c ƒëi·ªÉm n√†o</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Slot Modal -->
    <div class="modal fade" id="slotModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title"><i class="fas fa-users me-2"></i>Th√™m Slot</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="slotForm">
              <div class="mb-3" th:if="${activity.scope == 'FACULTY'}">
                <label class="form-label">Khoa</label>
                <select id="slotFacultyId" class="form-select" onchange="filterSlotClasses()">
                  <option value="">-- T·∫•t c·∫£ khoa --</option>
                  <option th:each="f : ${faculties}" th:value="${f.id}" th:text="${f.name}">Khoa</option>
                </select>
              </div>
              <div class="mb-3" th:if="${activity.scope == 'FACULTY'}">
                <label class="form-label">L·ªõp (t√πy ch·ªçn)</label>
                <select id="slotClassId" class="form-select">
                  <option value="">-- T·∫•t c·∫£ l·ªõp trong khoa --</option>
                  <option th:each="c : ${classes}" th:value="${c.id}" th:text="${c.name}" th:data-faculty="${c.facultyId}">L·ªõp</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">S·ªë l∆∞·ª£ng t·ªëi ƒëa <span class="text-danger">*</span></label>
                <input type="number" id="slotMaxQuantity" class="form-control" min="1" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="button" class="btn btn-success" onclick="saveSlot()">
              <i class="fas fa-save me-1"></i>L∆∞u
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Score Option Modal -->
    <div class="modal fade" id="scoreModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title"><i class="fas fa-trophy me-2"></i>Th√™m ƒêi·ªÉm/Gi·∫£i th∆∞·ªüng</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="scoreForm">
              <div class="mb-3">
                <label class="form-label">M·ª•c ƒëi·ªÉm <span class="text-danger">*</span></label>
                <select id="scoreCategory" class="form-select" required>
                  <option value="">-- Ch·ªçn m·ª•c ƒëi·ªÉm --</option>
                  <!-- Populated by JS from scoring rules -->
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Lo·∫°i tham gia <span class="text-danger">*</span></label>
                <input type="text" id="scoreName" class="form-control" placeholder="VD: Gi·∫£i nh·∫•t, Tham gia" required>
              </div>
              <div class="mb-3">
                <label class="form-label">ƒêi·ªÉm c·ªông <span class="text-danger">*</span></label>
                <input type="number" id="scoreValue" class="form-control" min="0" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Ghi ch√∫</label>
                <textarea id="scoreDescription" class="form-control" rows="2" placeholder="Ghi ch√∫ th√™m n·∫øu c√≥"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="button" class="btn btn-warning" onclick="saveScoreOption()">
              <i class="fas fa-save me-1"></i>L∆∞u
            </button>
          </div>
        </div>
      </div>
    </div>

    <div th:replace="~{admin/layout :: scripts}"></div>
    
    <script th:inline="javascript">
      const activityId = /*[[${activity.id}]]*/ 0;
      const apiBase = '/admin/activities/api';
      const scoringRulesJson = /*[[${scoringRulesJson}]]*/ '{}';
      const scoringRules = JSON.parse(scoringRulesJson);
      
      // Populate score category dropdown on load
      document.addEventListener('DOMContentLoaded', function() {
        const select = document.getElementById('scoreCategory');
        if (!scoringRules.categories) return;
        
        scoringRules.categories.forEach(cat => {
          const autoSubs = cat.subcategories.filter(sub => sub.type === 'AUTO_ACTIVITY');
          if (autoSubs.length === 0) return;
          
          const optgroup = document.createElement('optgroup');
          optgroup.label = `${cat.id}. ${cat.name}`;
          autoSubs.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.id;
            option.textContent = `${sub.id}. ${sub.name}`;
            optgroup.appendChild(option);
          });
          select.appendChild(optgroup);
        });
      });
      
      function openAddSlotModal() {
        document.getElementById('slotMaxQuantity').value = '';
        const facultyEl = document.getElementById('slotFacultyId');
        const classEl = document.getElementById('slotClassId');
        if (facultyEl) facultyEl.value = '';
        if (classEl) classEl.value = '';
        new bootstrap.Modal(document.getElementById('slotModal')).show();
      }
      
      function openAddScoreModal() {
        document.getElementById('scoreCategory').value = '';
        document.getElementById('scoreName').value = '';
        document.getElementById('scoreValue').value = '';
        document.getElementById('scoreDescription').value = '';
        new bootstrap.Modal(document.getElementById('scoreModal')).show();
      }
      
      function filterSlotClasses() {
        const facultyId = document.getElementById('slotFacultyId')?.value;
        const classSelect = document.getElementById('slotClassId');
        if (!classSelect) return;
        
        Array.from(classSelect.options).forEach(opt => {
          if (!opt.value) return;
          const optFacultyId = opt.dataset.faculty || '';
          opt.hidden = facultyId && optFacultyId !== facultyId;
        });
        classSelect.value = '';
      }
      
      async function saveSlot() {
        const data = {
          facultyId: document.getElementById('slotFacultyId')?.value || null,
          classId: document.getElementById('slotClassId')?.value || null,
          maxQuantity: document.getElementById('slotMaxQuantity').value
        };
        
        try {
          const response = await fetch(apiBase + '/' + activityId + '/slots', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (!response.ok) throw new Error('L·ªói khi l∆∞u');
          Toast.success('Th√™m slot th√†nh c√¥ng!');
          location.reload();
        } catch (error) {
          Toast.error('L·ªói: ' + error.message);
        }
      }
      
      async function deleteSlot(slotId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a slot n√†y?')) return;
        
        try {
          const response = await fetch(apiBase + '/slots/' + slotId, { method: 'DELETE' });
          if (!response.ok) throw new Error('L·ªói khi x√≥a');
          Toast.success('X√≥a slot th√†nh c√¥ng!');
          location.reload();
        } catch (error) {
          Toast.error('L·ªói: ' + error.message);
        }
      }
      
      async function saveScoreOption() {
        const data = {
          scoreCategory: document.getElementById('scoreCategory').value,
          name: document.getElementById('scoreName').value,
          scoreValue: document.getElementById('scoreValue').value,
          description: document.getElementById('scoreDescription').value
        };
        
        try {
          const response = await fetch(apiBase + '/' + activityId + '/score-options', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (!response.ok) throw new Error('L·ªói khi l∆∞u');
          Toast.success('Th√™m ƒëi·ªÉm th√†nh c√¥ng!');
          location.reload();
        } catch (error) {
          Toast.error('L·ªói: ' + error.message);
        }
      }
      
      async function deleteScoreOption(id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª©c ƒëi·ªÉm n√†y?')) return;
        
        try {
          const response = await fetch(apiBase + '/score-options/' + id, { method: 'DELETE' });
          if (!response.ok) throw new Error('L·ªói khi x√≥a');
          Toast.success('X√≥a m·ª©c ƒëi·ªÉm th√†nh c√¥ng!');
          location.reload();
        } catch (error) {
          Toast.error('L·ªói: ' + error.message);
        }
      }
    </script>
  </body>
</html>
