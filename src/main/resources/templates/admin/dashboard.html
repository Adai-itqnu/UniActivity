<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{admin/layout :: header}"></head>
  <body>
    <div th:replace="~{admin/layout :: sidebar}"></div>

    <div class="content">
      <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header mb-4">
          <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
          <p class="text-muted mb-0">Tổng quan hệ thống UniActivity 4.0</p>
        </div>

        <!-- Main Statistics Cards - Enhanced -->
        <div class="row mb-4">
          <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm stat-card-new">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon-wrapper bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                    <i class="fas fa-university fa-2x text-primary"></i>
                  </div>
                  <div>
                    <h3 class="mb-0 fw-bold" th:text="${totalFaculties} ?: 0">0</h3>
                    <small class="text-muted">Tổng số Khoa</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm stat-card-new">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon-wrapper bg-success bg-opacity-10 rounded-circle p-3 me-3">
                    <i class="fas fa-chalkboard-teacher fa-2x text-success"></i>
                  </div>
                  <div>
                    <h3 class="mb-0 fw-bold" th:text="${totalClasses} ?: 0">0</h3>
                    <small class="text-muted">Tổng số Lớp</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm stat-card-new">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon-wrapper bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                    <i class="fas fa-user-graduate fa-2x text-warning"></i>
                  </div>
                  <div>
                    <h3 class="mb-0 fw-bold" th:text="${totalStudents} ?: 0">0</h3>
                    <small class="text-muted">Tổng Sinh viên</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm stat-card-new">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stat-icon-wrapper bg-info bg-opacity-10 rounded-circle p-3 me-3">
                    <i class="fas fa-calendar-check fa-2x text-info"></i>
                  </div>
                  <div>
                    <h3 class="mb-0 fw-bold" th:text="${activeActivities} ?: 0">0</h3>
                    <small class="text-muted">Hoạt động đang mở</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
          <!-- Activities Chart -->
          <div class="col-md-8 mb-4">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-chart-bar me-2 text-primary"></i>Thống kê hoạt động</span>
                <a th:href="@{/admin/activities}" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
              </div>
              <div class="card-body">
                <canvas id="activitiesChart" height="200"></canvas>
              </div>
            </div>
          </div>
          
          <!-- User Distribution Pie Chart -->
          <div class="col-md-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-white border-0">
                <i class="fas fa-chart-pie me-2 text-success"></i>Phân bổ người dùng
              </div>
              <div class="card-body d-flex align-items-center justify-content-center">
                <div style="width: 200px; height: 200px;">
                  <canvas id="userChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activities Timeline & Faculty List -->
        <div class="row mb-4">
          <!-- Recent Activities Timeline -->
          <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-history me-2 text-info"></i>Hoạt động gần đây</span>
                <a th:href="@{/admin/activities}" class="btn btn-sm btn-outline-info">Xem tất cả</a>
              </div>
              <div class="card-body p-0">
                <div class="timeline-container" style="max-height: 350px; overflow-y: auto;">
                  <div th:if="${recentActivities == null or #lists.isEmpty(recentActivities)}" 
                       class="text-center text-muted py-5">
                    <i class="fas fa-calendar-times fa-3x mb-3"></i>
                    <p>Chưa có hoạt động nào</p>
                  </div>
                  <div class="timeline" th:if="${recentActivities != null and !#lists.isEmpty(recentActivities)}">
                    <div th:each="act, iter : ${recentActivities}" class="timeline-item">
                      <div class="timeline-marker" 
                           th:classappend="${act.status == 'OPEN' ? 'bg-success' : 
                                           act.status == 'DRAFT' ? 'bg-secondary' : 'bg-dark'}"></div>
                      <div class="timeline-content">
                        <h6 class="mb-1" th:text="${act.name}">Hoạt động ABC</h6>
                        <div class="d-flex gap-2">
                          <span th:if="${act.scope == 'SCHOOL'}" class="badge bg-primary">Toàn trường</span>
                          <span th:if="${act.scope == 'FACULTY'}" class="badge bg-info">Theo khoa</span>
                          <span th:if="${act.status == 'DRAFT'}" class="badge bg-secondary">Nháp</span>
                          <span th:if="${act.status == 'OPEN'}" class="badge bg-success">Đang mở</span>
                          <span th:if="${act.status == 'FINISHED'}" class="badge bg-dark">Kết thúc</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Faculty List with Search -->
          <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-white border-0">
                <div class="row align-items-center">
                  <div class="col">
                    <i class="fas fa-university me-2 text-primary"></i>Danh sách Khoa
                  </div>
                  <div class="col-auto">
                    <input type="text" class="form-control form-control-sm" id="facultySearch" 
                           placeholder="Tìm kiếm..." style="width: 150px;">
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                  <table class="table table-hover mb-0" id="facultyTable">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th>Khoa</th>
                        <th>Mã</th>
                        <th>Trạng thái</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="f : ${faculties}">
                        <td th:text="${f.name}">Khoa CNTT</td>
                        <td><span class="badge bg-secondary" th:text="${f.code}">CNTT</span></td>
                        <td>
                          <span th:if="${f.status == 'ACTIVE'}" class="badge bg-success">Hoạt động</span>
                          <span th:if="${f.status != 'ACTIVE'}" class="badge bg-danger">Ngừng</span>
                        </td>
                      </tr>
                      <tr th:if="${faculties == null or #lists.isEmpty(faculties)}">
                        <td colspan="3" class="text-center text-muted py-3">Chưa có dữ liệu</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Classes Table with Search/Filter -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-white border-0">
                <div class="row align-items-center">
                  <div class="col-md-4">
                    <i class="fas fa-users me-2 text-success"></i>Danh sách Lớp
                  </div>
                  <div class="col-md-4">
                    <input type="text" class="form-control" id="classSearch" placeholder="Tìm kiếm lớp...">
                  </div>
                  <div class="col-md-4 text-end">
                    <a th:href="@{/admin/classes}" class="btn btn-outline-primary btn-sm">Quản lý lớp</a>
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                  <table class="table table-hover mb-0" id="classTable">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th>Mã lớp</th>
                        <th>Tên lớp</th>
                        <th>Khoa</th>
                        <th>Khóa</th>
                        <th>Join Code</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="c : ${classes}">
                        <td><span class="badge bg-secondary" th:text="${c.code}">CNTT-K45A</span></td>
                        <td th:text="${c.name}">Lớp CNTT K45A</td>
                        <td><span class="badge bg-primary" th:text="${c.facultyName} ?: 'Chưa gán'">Khoa</span></td>
                        <td><span class="badge bg-info" th:text="${c.academicYearCode} ?: 'Chưa gán'">Khóa</span></td>
                        <td><code th:text="${c.joinCode}">ABC123</code></td>
                      </tr>
                      <tr th:if="${classes == null or #lists.isEmpty(classes)}">
                        <td colspan="5" class="text-center text-muted py-3">Chưa có dữ liệu</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions & System Info -->
        <div class="row mb-4">
          <div class="col-md-8">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-white border-0">
                <i class="fas fa-bolt me-2 text-warning"></i>Thao tác nhanh
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3 mb-3">
                    <a th:href="@{/admin/faculties}" class="card border-0 bg-primary bg-opacity-10 text-decoration-none action-card h-100">
                      <div class="card-body text-center py-4">
                        <i class="fas fa-university fa-2x text-primary mb-2"></i>
                        <h6 class="mb-0 text-primary">Quản lý Khoa</h6>
                      </div>
                    </a>
                  </div>
                  <div class="col-md-3 mb-3">
                    <a th:href="@{/admin/classes}" class="card border-0 bg-success bg-opacity-10 text-decoration-none action-card h-100">
                      <div class="card-body text-center py-4">
                        <i class="fas fa-chalkboard-teacher fa-2x text-success mb-2"></i>
                        <h6 class="mb-0 text-success">Quản lý Lớp</h6>
                      </div>
                    </a>
                  </div>
                  <div class="col-md-3 mb-3">
                    <a th:href="@{/admin/users}" class="card border-0 bg-warning bg-opacity-10 text-decoration-none action-card h-100">
                      <div class="card-body text-center py-4">
                        <i class="fas fa-users fa-2x text-warning mb-2"></i>
                        <h6 class="mb-0 text-warning">Quản lý Users</h6>
                      </div>
                    </a>
                  </div>
                  <div class="col-md-3 mb-3">
                    <a th:href="@{/admin/activities}" class="card border-0 bg-info bg-opacity-10 text-decoration-none action-card h-100">
                      <div class="card-body text-center py-4">
                        <i class="fas fa-calendar-alt fa-2x text-info mb-2"></i>
                        <h6 class="mb-0 text-info">Quản lý HĐ</h6>
                      </div>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-white border-0">
                <i class="fas fa-info-circle me-2 text-secondary"></i>Thông tin hệ thống
              </div>
              <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-calendar me-2 text-muted"></i>Học kỳ hiện tại</span>
                    <span class="badge bg-success" th:text="${currentSemester?.name} ?: 'Chưa thiết lập'">HK1</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-tasks me-2 text-muted"></i>Tổng hoạt động</span>
                    <span class="badge bg-primary" th:text="${totalActivities} ?: 0">0</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-users me-2 text-muted"></i>Tổng người dùng</span>
                    <span class="badge bg-info" th:text="${totalUsers} ?: 0">0</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-code-branch me-2 text-muted"></i>Phiên bản</span>
                    <span class="badge bg-secondary">4.0</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <div th:replace="~{admin/layout :: scripts}"></div>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script th:inline="javascript">
      document.addEventListener('DOMContentLoaded', function() {
        // Activities Bar Chart
        const activitiesCtx = document.getElementById('activitiesChart');
        if (activitiesCtx) {
          new Chart(activitiesCtx, {
            type: 'bar',
            data: {
              labels: ['Tổng HĐ', 'Đang mở', 'Nháp', 'Kết thúc'],
              datasets: [{
                label: 'Số lượng',
                data: [
                  /*[[${totalActivities}]]*/ 0,
                  /*[[${activeActivities}]]*/ 0,
                  0, // Draft count - could be added to controller
                  0  // Finished count
                ],
                backgroundColor: [
                  'rgba(13, 110, 253, 0.8)',
                  'rgba(25, 135, 84, 0.8)',
                  'rgba(108, 117, 125, 0.8)',
                  'rgba(33, 37, 41, 0.8)'
                ],
                borderRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: true } }
            }
          });
        }

        // User Distribution Pie Chart
        const userCtx = document.getElementById('userChart');
        if (userCtx) {
          new Chart(userCtx, {
            type: 'doughnut',
            data: {
              labels: ['Sinh viên', 'Manager', 'Admin'],
              datasets: [{
                data: [
                  /*[[${totalStudents}]]*/ 0,
                  /*[[${totalUsers - totalStudents - 1}]]*/ 0, // Approximate managers
                  1
                ],
                backgroundColor: ['#ffc107', '#17a2b8', '#dc3545'],
                borderWidth: 0,
                cutout: '60%'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { 
                legend: { position: 'bottom', labels: { padding: 15 } }
              }
            }
          });
        }

        // Faculty Search
        document.getElementById('facultySearch')?.addEventListener('input', function() {
          filterTable('facultyTable', this.value);
        });

        // Class Search
        document.getElementById('classSearch')?.addEventListener('input', function() {
          filterTable('classTable', this.value);
        });
      });

      function filterTable(tableId, searchTerm) {
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const term = searchTerm.toLowerCase();
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(term) ? '' : 'none';
        });
      }
    </script>
    
    <style>
      .stat-card-new {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .stat-card-new:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
      }
      .action-card {
        transition: transform 0.3s ease;
      }
      .action-card:hover {
        transform: translateY(-5px);
      }
      /* Timeline Styles */
      .timeline {
        position: relative;
        padding: 20px 0;
      }
      .timeline-item {
        position: relative;
        padding: 15px 20px 15px 40px;
        border-left: 2px solid #e9ecef;
        margin-left: 20px;
      }
      .timeline-marker {
        position: absolute;
        left: -8px;
        top: 20px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 0 2px #dee2e6;
      }
      .timeline-content {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px 15px;
      }
    </style>
  </body>
</html>
