<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{manager/layout :: header}"></head>
  <body>
    <div th:replace="~{manager/layout :: sidebar}"></div>

    <div class="content">
      <div class="container-fluid">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2><i class="fas fa-user-plus me-2"></i>Yêu cầu tham gia lớp</h2>
            <p class="text-muted mb-0" th:if="${studentClass != null}">
              Lớp: <strong th:text="${studentClass.name}">Lớp</strong>
            </p>
          </div>
        </div>

        <!-- No Class Alert -->
        <div th:if="${studentClass == null}" class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Bạn chưa được gán quản lý lớp nào.
        </div>

        <!-- Join Code Card -->
        <div th:if="${studentClass != null}" class="card mb-4 border-success">
          <div class="card-header bg-success text-white">
            <i class="fas fa-key me-2"></i>Mã mời tham gia lớp
          </div>
          <div class="card-body text-center">
            <div th:if="${studentClass.joinCode != null && !studentClass.joinCode.isEmpty()}">
              <p class="mb-2">Chia sẻ mã này cho sinh viên để tham gia lớp:</p>
              <h2 class="text-success mb-3">
                <code th:text="${studentClass.joinCode}" id="joinCodeDisplay">ABC123</code>
                <button class="btn btn-outline-success btn-sm ms-2" onclick="copyJoinCode()">
                  <i class="fas fa-copy"></i>
                </button>
              </h2>
              <button class="btn btn-primary" onclick="showQRModal()">
                <i class="fas fa-qrcode me-2"></i>Hiển thị QR Code
              </button>
              <button class="btn btn-outline-warning ms-2" onclick="regenerateCode()">
                <i class="fas fa-sync me-1"></i>Tạo mã mới
              </button>
            </div>
            <div th:if="${studentClass.joinCode == null || studentClass.joinCode.isEmpty()}">
              <p class="text-muted mb-3">Lớp chưa có mã tham gia. Nhấn nút bên dưới để tạo mã mới.</p>
              <button class="btn btn-success btn-lg" onclick="regenerateCode()">
                <i class="fas fa-key me-2"></i>Tạo mã tham gia
              </button>
            </div>
          </div>
        </div>

        <!-- Pending Requests Table -->
        <div th:if="${studentClass != null}" class="card">
          <div class="card-header">
            <i class="fas fa-clock me-2"></i>Yêu cầu đang chờ duyệt
            <span class="badge bg-info ms-2" th:text="${pendingRequests?.size()} ?: 0">0</span>
          </div>
          <div class="card-body">
            <div th:if="${pendingRequests == null || pendingRequests.isEmpty()}" class="text-center text-muted py-4">
              <i class="fas fa-inbox fa-3x mb-3"></i>
              <p>Không có yêu cầu nào đang chờ duyệt</p>
            </div>

            <table th:if="${pendingRequests != null && !pendingRequests.isEmpty()}" class="table table-hover">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Họ tên</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Thời gian gửi</th>
                  <th class="text-end">Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="request, stat : ${pendingRequests}">
                  <td th:text="${stat.index + 1}">1</td>
                  <td th:text="${request.user.fullName}">Nguyễn Văn A</td>
                  <td><code th:text="${request.user.username}">sinhvien01</code></td>
                  <td th:text="${request.user.email}">email@example.com</td>
                  <td th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2024</td>
                  <td class="text-end">
                    <button class="btn btn-success btn-sm me-1" 
                            th:onclick="|approveRequest(${request.id})|">
                      <i class="fas fa-check me-1"></i>Duyệt
                    </button>
                    <button class="btn btn-danger btn-sm" 
                            th:onclick="|rejectRequest(${request.id})|">
                      <i class="fas fa-times me-1"></i>Từ chối
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title"><i class="fas fa-qrcode me-2"></i>Mã QR tham gia lớp</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center py-4">
            <div id="qrContainer">
              <canvas id="qrCanvas"></canvas>
            </div>
            <div class="alert alert-success mt-3 mb-0">
              <small>Sinh viên quét mã này để gửi yêu cầu tham gia lớp</small>
            </div>
          </div>
          <div class="modal-footer justify-content-center">
            <button class="btn btn-outline-primary" onclick="downloadQR()">
              <i class="fas fa-download me-1"></i>Tải xuống
            </button>
          </div>
        </div>
      </div>
    </div>

    <div th:replace="~{manager/layout :: scripts}"></div>
    
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script th:inline="javascript">
      const joinCode = [[${studentClass?.joinCode}]];
      let qrGenerated = false;

      function copyJoinCode() {
        const code = document.getElementById('joinCodeDisplay').textContent;
        navigator.clipboard.writeText(code).then(() => {
          Toast.success('Đã sao chép mã: ' + code);
        });
      }

      function showQRModal() {
        const modal = new bootstrap.Modal(document.getElementById('qrModal'));
        modal.show();
        
        if (!qrGenerated && joinCode) {
          setTimeout(() => {
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
              text: joinCode,
              width: 256,
              height: 256,
              colorDark: "#198754",
              colorLight: "#ffffff"
            });
            qrGenerated = true;
          }, 100);
        }
      }

      function downloadQR() {
        const canvas = document.querySelector('#qrContainer canvas');
        if (canvas) {
          const link = document.createElement('a');
          link.download = 'join_class_qr.png';
          link.href = canvas.toDataURL();
          link.click();
        }
      }

      async function regenerateCode() {
        if (!confirm('Tạo mã tham gia mới? Mã cũ sẽ không còn hiệu lực.')) return;
        
        try {
          Loading.show();
          const response = await fetch('/manager/api/regenerate-join-code', {
            method: 'POST'
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.message || 'Không thể tạo mã mới');
          }
          
          Toast.success('Đã tạo mã mới: ' + result.joinCode);
          setTimeout(() => location.reload(), 500);
        } catch (error) {
          Toast.error('Lỗi: ' + error.message);
        } finally {
          Loading.hide();
        }
      }

      async function approveRequest(id) {
        if (!confirm('Duyệt yêu cầu tham gia này?')) return;
        
        try {
          Loading.show();
          const response = await fetch(`/manager/api/join-requests/${id}/approve`, {
            method: 'POST'
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.message || 'Không thể duyệt yêu cầu');
          }
          
          Toast.success('Đã duyệt yêu cầu!');
          setTimeout(() => location.reload(), 500);
        } catch (error) {
          Toast.error('Lỗi: ' + error.message);
        } finally {
          Loading.hide();
        }
      }
      
      async function rejectRequest(id) {
        if (!confirm('Từ chối yêu cầu tham gia này?')) return;
        
        try {
          Loading.show();
          const response = await fetch(`/manager/api/join-requests/${id}/reject`, {
            method: 'POST'
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.message || 'Không thể từ chối yêu cầu');
          }
          
          Toast.success('Đã từ chối yêu cầu');
          setTimeout(() => location.reload(), 500);
        } catch (error) {
          Toast.error('Lỗi: ' + error.message);
        } finally {
          Loading.hide();
        }
      }
    </script>
  </body>
</html>
